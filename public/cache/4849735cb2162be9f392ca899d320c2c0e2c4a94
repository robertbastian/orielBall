{"content":"var guestNumber = 0\nvar type\n\nvar handler = StripeCheckout.configure({\n  key: STRIPE,\n  currency: 'gbp',\n  image: 'https://www.orielball.uk/images/apple-touch-icon.png',\n  allowRememberMe: false,\n  // Callback function: appends the charge token and send the form\n  token: function(token){\n    if (adjustGuests()){\n      $('#payment-form').get(0).submit()\n      $('#payment-form').append($('<input type=\"hidden\" name=\"guests\" />').val(guestNumber))\n      $('#payment-form').append($('<input type=\"hidden\" name=\"stripeToken\" />').val(token.id))\n    }\n  },\n  closed: function(){\n    btn.button('reset')\n  }\n})\n\n$(document).ready(function(){\n  // Initializes bodcard tooltip\n  $('#bodcardHelp').tooltip({\n    placement: 'top',\n    title:'This is the seven-digit number above the barcode',\n    container:'body'\n  })\n  \n  // Initializes college selector\n  $('#college select').selectize({\n    maxItems: 1,\n    sortField: {\n      field: 'text',\n      direction: 'asc'\n    }\n  })\n\n  $('#pay').click(function(){\n    if (verifyInput()) {\n      $(this).button('loading')\n      // Opens the stripe window\n      handler.open({\n        email: $('#email input').val(),\n        name: $('#name input').val(),\n        description: (1+guestNumber) + ' ' + type.toLowerCase() + ' ticket' + ((guestNumber>0)?'s':''),\n        amount: PRICES[type] * 100 * (1+guestNumber)\n      })\n    }\n    // Disables actually submitting the form\n    return false\n  })\n\n  $('#addGuest').click(function(){\n    if (moreGuestsAllowed()){\n      guestNumber++\n      $('#guestList').append($('<div class=\"form-group\"><div class=\"input-group\"><span class=\"input-group-addon\"><i class=\"fa fa-user fa-fw\"></i></span><input name=\"guestNames['+guestNumber+']\" type=\"text\" placeholder=\"Name\" class=\"form-control\"><span class=\"input-group-btn\"><button class=\"btn btn-default\" id=\"removeGuest'+guestNumber+'\" type=\"button\"><i class=\"fa fa-minus\"></i></button></span></div><div class=\"input-group\"><span class=\"input-group-addon\"><i class=\"fa fa-at fa-fw\"></i></span><input name=\"guestEmails['+guestNumber+']\" type=\"email\" placeholder=\"Email address\" class=\"form-control\"></div></div>'))\n      $('#removeGuest'+guestNumber).click(function(){\n        $(this).parent().parent().parent().remove()\n        guestNumber--\n        return false\n      })\n    }\n    return false\n  })\n\n\n  $('#type label').change(function(){\n    type = $('input[name=type]:checked').val()\n    adjustGuests()\n  })\n  $('#nonDiningToggle').click()\n\n  // Start updating tickets\n  updateTickets()\n})\n\n// Checks whether a guest can be added\nvar moreGuestsAllowed = function(){\n  if (guestNumber + 1 == MAX_GUEST_NUMBER) {\n    var alert = $('<div class=\"alert alert-danger\">You can only buy a maximum of '+MAX_GUEST_NUMBER+' tickets <button type=\"button\" class=\"close\" data-dismiss=\"alert\"><span aria-hidden=\"true\">&times;</span><span class=\"sr-only\">Close</span></button></div>')\n    alert.alert()\n    alert.appendTo($('#errorBox'))\n  }\n  else if (1 + guestNumber >= remaining[type]) {\n    var alert = $('<div class=\"alert alert-danger\">There are not enough tickets of this type left <button type=\"button\" class=\"close\" data-dismiss=\"alert\"><span aria-hidden=\"true\">&times;</span><span class=\"sr-only\">Close</span></button></div>')\n    alert.alert()\n    alert.appendTo($('#errorBox'))\n  }\n  else\n    return true\n  return false\n}\n\n// Verifies inputs\nvar verifyInput = function(){\n  // Assumes everything went alright\n  $('.has-error').removeClass('has-error')\n  \n  // Name has to be first and last name\n  if (!/^.+ .+$/.test($('#name input').val()))\n    $('#name').addClass('has-error')\n\n  // Email has to oriel.ox.ac.uk || (.ox.ac.uk && !orielOnly), guard is the negative\n  var email = $('#email input').val()\n  if (!/^[a-zA-Z0-9_.+-]+@oriel\\.ox\\.ac\\.uk$/.test(email) && (!/^[a-zA-Z0-9_.+-]+@[a-zA-Z0-9_.+-]+\\.ox\\.ac\\.uk$/.test(email) || orielOnly)\n    $('#email').addClass('has-error')\n\n  // Bodcard has to be seven digits\n  if (!/^[0-9]{7}$/.test($('#bodcard input').val()))\n    $('#bodcard').addClass('has-error')\n\n  // College has to be non-empty\n  if ($('#college select').val() == '')\n    $('#college').addClass('has-error')\n  \n  // Everything ok\n  return $('.has-error').length == 0\n}\n\nvar adjustGuests = function(){\n  var tooMany = ($('#guestList .form-group').length + 1) - remaining[type]\n  if (tooMany > 0)\n  {\n    for (var i = 0; i < tooMany; i++){\n      $('#guestList .form-group:last').remove()\n      guestNumber--\n    }\n    var alert = $('<div class=\"alert alert-danger\">'+tooMany+' of your guests had to be removed, because there aren\\'t enough tickets left. <button type=\"button\" class=\"close\" data-dismiss=\"alert\"><span aria-hidden=\"true\">&times;</span><span class=\"sr-only\">Close</span></button></div>')\n    alert.alert()\n    alert.appendTo($('#errorBox'))\n    return false\n  }\n  return true\n}\n\nvar adjustButtons = function(){\n  \n  // Selected ticket just sold out, shows error message\n  if (remaining['Non-dining'] == 0 && type == 'Non-dining' || remaining['Dining'] == 0 && type == 'Dining'){\n    var alert = $('<div class=\"alert alert-danger\">Your ticket type was changed because '+type.toLowerCase()+' tickets just sold out. <button type=\"button\" class=\"close\" data-dismiss=\"alert\"><span aria-hidden=\"true\">&times;</span><span class=\"sr-only\">Close</span></button></div>')\n    alert.alert()\n    alert.appendTo($('#errorBox'))\n  }\n\n  // Disable and select other ticket\n  if (remaining['Non-dining'] == 0) {\n    $('#nonDiningToggle').addClass('disabled')\n    $('#diningToggle').click()\n  }\n  else if (remaining['Dining'] == 0) {\n    $('#diningToggle').addClass('disabled')\n    $('#nonDiningToggle').click()\n  }\n}\n\n// Updates remaining tickets in menubar\nvar updateTickets = function(){\n  $.post('/ticketsLeft')\n  .done(function(left)\n  {\n    remaining = {\n      'Non-dining': left[0],\n      'Dining': left[1]\n    }\n\n    // If no tickets are left, reload, this will become the 'sold out' page\n    if (remaining['Non-dining'] + remaining['Dining'] == 0)\n     location.reload()\n    \n    adjustButtons()\n    adjustGuests()\n\n    // Update menubar\n    $('#nonDiningLeft').html('&nbsp;'+remaining['Non-dining'])\n    $('#diningLeft').html('&nbsp;'+remaining['Dining'])\n\n    // And load again in 10s\n    setTimeout(updateTickets,10000)\n  })\n  .fail(function(err){\n    // On fail, retry in 30s\n    setTimeout(updateTickets,30000)\n  })\n}"}